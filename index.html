<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel (Multi-Project)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-bg: #0b0f30;
            --secondary-bg: #121740;
            --accent-color: #d1e231;
            --text-color: #ffffff;
            --gradient-start: #ff006b;
            --gradient-mid: #FF9800;
            --gradient-end: #FFEB3B;
            --danger-color: #f44336;
            --success-color: #4CAF50;
            --info-color: #2196F3;
            --warn-color: #f39c12;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background-color: var(--primary-bg); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; flex-direction: column; } /* Added flex-direction for mobile */

        /* Main Menu / Sidebar */
        #mainMenu {
            position: fixed;
            top: 0;
            left: -260px;
            width: 250px;
            height: 100%;
            background-color: var(--secondary-bg);
            padding-top: 60px;
            transition: left 0.3s ease-in-out;
            z-index: 1100;
            border-right: 2px solid var(--accent-color);
            box-shadow: 5px 0 15px rgba(0,0,0,0.2);
        }
        #mainMenu.open { left: 0; }
        #mainMenu .menu-header { color: var(--accent-color); padding: 10px 20px; font-size: 1.5em; text-align: center; border-bottom: 1px solid #333; margin-bottom: 20px; }
        #mainMenu a { padding: 15px 20px; text-decoration: none; font-size: 18px; color: var(--text-color); display: flex; align-items: center; gap: 15px; transition: background-color 0.2s, color 0.2s; cursor: pointer; }
        #mainMenu a:hover { background-color: var(--primary-bg); }
        #mainMenu a.active { background-color: var(--accent-color); color: var(--primary-bg); font-weight: bold; }

        /* Menu Toggle Button (for mobile) */
        #menuToggleBtn {
            position: fixed;
            top: 15px; /* Adjusted for better visibility */
            left: 15px; /* Adjusted for better visibility */
            background: var(--secondary-bg);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            border-radius: 5px; /* More standard corners */
            width: 50px; /* Slightly larger touch target */
            height: 50px; /* Slightly larger touch target */
            cursor: pointer;
            z-index: 1200;
            font-size: 24px;
            display: flex; /* Always display but hide with media query for desktop */
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* Add a subtle shadow */
        }
        #menuToggleBtn:hover { background-color: var(--primary-bg); }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            height: 100vh;
            transition: margin-left 0.3s ease-in-out;
            width: 100%; /* Ensure it takes full width initially */
        }

        /* Login Container */
        .login-container {
            background-color: var(--secondary-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            width: 90%; /* Responsive width */
            max-width: 400px;
            margin: 50px auto;
            text-align: center;
        }

        /* Page Containers */
        .page-container {
            display: none;
            background-color: var(--secondary-bg);
            padding: 20px; /* Slightly reduced padding for mobile */
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 800px; /* Max width remains for larger screens */
            margin: 20px auto;
        }
        .page-container.active { display: block; }

        h1, h2 { text-align: center; color: var(--accent-color); margin-bottom: 20px; }

        /* Admin Header (Top bar) */
        .admin-header {
            display: flex;
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0; /* Add some vertical padding */
            gap: 10px; /* Space between items */
        }

        /* Logged in user email display */
        #adminEmailDisplay {
            font-size: 0.9em; /* Slightly smaller for mobile */
            color: #aaa;
            font-weight: normal;
            text-align: center; /* Center on small screens */
            width: 100%; /* Take full width on small screens */
            order: 3; /* Order it below title and logout on small screens */
        }

        /* Logout Button */
        .logout-btn {
            background: var(--danger-color);
            width: auto;
            padding: 10px 15px;
            font-size: 14px; /* Smaller font for mobile */
            order: 2; /* Order it after the title on small screens */
        }

        /* Form elements */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #333; border-radius: 5px; background-color: var(--primary-bg); color: var(--text-color); font-size: 16px; }
        .form-group input[readonly] { background-color: #2a2f50; cursor: not-allowed; opacity: 0.7; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent-color); }
        button { display: inline-block; width: 100%; padding: 15px; background: linear-gradient(45deg, var(--gradient-start), var(--gradient-mid), var(--gradient-end)); color: var(--text-color); border: none; border-radius: 5px; font-size: 18px; cursor: pointer; transition: transform 0.2s ease, opacity 0.2s; margin-top: 10px; position: relative; text-align: center; }
        button:hover { transform: translateY(-2px); opacity: 0.9; }
        button.loading { color: transparent !important; pointer-events: none; }
        button .spinner { display: none; border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid white; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        button.loading .spinner { display: block; }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px 20px; background-color: var(--primary-bg); padding: 15px; border-radius: 5px; border: 1px solid #333; }
        .checkbox-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal; }
        .checkbox-group input[type="checkbox"] { height: 18px; width: 18px; cursor: pointer; }
        .message { margin-top: 20px; padding: 12px; border-radius: 5px; text-align: center; display: none; }
        .message.success { background-color: var(--success-color); }
        .message.error { background-color: var(--danger-color); }
        .message.info { background-color: var(--info-color); }
        .result-item { background-color: var(--primary-bg); padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; flex-direction: column; /* Stack on mobile */ align-items: flex-start; /* Align items to start */ justify-content: space-between; gap: 10px; /* Space between stacked items */ }
        .result-item span { text-align: left; width: 100%; } /* Ensure text takes full width */
        .result-item-actions { display: flex; flex-wrap: wrap; /* Allow buttons to wrap */ gap: 8px; width: 100%; /* Take full width */ justify-content: flex-start; /* Align buttons to start */ }
        .action-btn { background-color: var(--accent-color) !important; color: var(--primary-bg) !important; padding: 8px 12px !important; border-radius: 5px !important; width: auto !important; font-size: 14px !important; margin-top: 0 !important; flex-grow: 1; /* Allow buttons to grow */ min-width: 80px; /* Minimum width for buttons */ }
        .action-btn.edit { background-color: var(--warn-color) !important; color: white !important; }
        .action-btn.delete { background-color: var(--danger-color) !important; color: white !important; }
        .action-btn.select-delete.selected { background-color: var(--success-color) !important; color: white !important; }
        .banner-nav-tabs { display: flex; flex-wrap: wrap; /* Allow tabs to wrap */ border-bottom: 1px solid var(--accent-color); margin-bottom: 20px; }
        .banner-tab-link { padding: 10px 15px; /* Reduced padding */ cursor: pointer; color: #aaa; border: none; background: none; font-size: 15px; /* Slightly smaller font */ flex-grow: 1; /* Allow tabs to grow and fill space */ text-align: center; /* Center text in tabs */ }
        .banner-tab-link.active { color: var(--accent-color); border-bottom: 2px solid var(--accent-color); font-weight: bold; }
        .banner-tab-content { display: none; }
        .banner-tab-content.active { display: block; }
        #allBannersContainer { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Min card size reduced for mobile */ gap: 15px; /* Reduced gap */ margin-top: 20px; }
        .banner-card { background-color: var(--primary-bg); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .banner-card img { width: 100%; height: 120px; /* Reduced image height */ object-fit: cover; background-color: #000; }
        .banner-card-content { padding: 10px; /* Reduced padding */ flex-grow: 1; display: flex; flex-direction: column; }
        .banner-card h3 { font-size: 1em; /* Slightly smaller font */ color: var(--accent-color); margin-bottom: 5px; text-align: left; }
        .banner-card p { font-size: 0.8em; /* Slightly smaller font */ color: #ccc; margin-bottom: 10px; flex-grow: 1; line-height: 1.4; }
        .banner-card-actions { display: flex; gap: 8px; /* Reduced gap */ margin-top: auto; border-top: 1px solid #333; padding-top: 8px; /* Reduced padding */ }
        .banner-card-actions .action-btn { width: 100% !important; flex: 1; }
        .banner-card-actions .action-btn.delete { background-color: var(--danger-color) !important; color: white !important; }

        /* Styles for User Management Section */
        #userManagementPage .input-group { margin-bottom: 15px; }
        #userManagementPage .input-group label { display: block; margin-bottom: 8px; color: #ccc; font-size: 14px; }
        #userManagementPage .input-group input, #userManagementPage .input-group select { width: 100%; padding: 10px; /* Slightly less padding */ background: #222; border: 1px solid #444; border-radius: 8px; color: white; font-size: 15px; }
        #userManagementPage .btn-secondary { background: #555; }
        #userManagementPage hr { border-color: #444; margin: 20px 0; /* Reduced margin */ }

        /* --- Media Queries for Responsiveness --- */
        @media (max-width: 768px) {
            body {
                flex-direction: column; /* Stack body content */
            }

            #mainMenu {
                left: -260px; /* Keep it off-screen by default */
                width: 250px;
                padding-top: 80px; /* Make space for toggle button */
            }
            #mainMenu.open {
                left: 0;
            }

            #menuToggleBtn {
                display: flex; /* Show toggle button on small screens */
            }

            .main-content {
                margin-left: 0; /* No margin on small screens */
                padding: 15px; /* Slightly less padding */
                overflow-x: hidden; /* Prevent horizontal scroll */
            }
            
            /* Adjust admin header for small screens */
            .admin-header {
                flex-direction: column; /* Stack items */
                align-items: flex-start; /* Align to start */
                margin-top: 60px; /* Push content down to avoid overlapping toggle */
            }
            #pageTitle {
                width: 100%; /* Take full width */
                text-align: left; /* Align to left */
                font-size: 1.8em; /* Slightly smaller for mobile */
                margin-bottom: 10px;
                order: 1; /* Place it first */
            }
            #adminEmailDisplay {
                width: 100%;
                text-align: left; /* Align to left */
                font-size: 0.8em; /* Make it smaller */
                margin-bottom: 10px;
                order: 3; /* Place it after the logout button for better flow */
            }
            .logout-btn {
                width: auto; /* Let button size itself */
                order: 2; /* Place it second */
                margin-left: auto; /* Push to the right if space allows */
                margin-top: -40px; /* Pull it up to sit next to the title if space allows */
            }

            .page-container {
                padding: 15px;
                margin: 15px auto;
            }

            .result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .result-item-actions {
                flex-direction: column;
                width: 100%;
            }
            .action-btn {
                width: 100% !important; /* Full width buttons in results */
            }

            #allBannersContainer {
                grid-template-columns: 1fr; /* Single column on very small screens */
            }
            .banner-card img {
                height: 100px; /* Even smaller image height */
            }
            .banner-card-content {
                padding: 8px;
            }
            .banner-card h3 {
                font-size: 0.9em;
            }
            .banner-card p {
                font-size: 0.75em;
            }
            .banner-tab-link {
                font-size: 14px;
                padding: 8px 10px;
            }
        }

        /* Desktop adjustments */
        @media (min-width: 769px) {
            body {
                flex-direction: row; /* Side-by-side for desktop */
            }
            #mainMenu {
                position: relative; /* Take it out of fixed positioning */
                left: 0 !important; /* Ensure it's always visible */
                flex-shrink: 0; /* Prevent it from shrinking */
                padding-top: 20px; /* Adjust padding */
                box-shadow: none; /* Remove shadow */
            }
            #menuToggleBtn {
                display: none; /* Hide toggle button on desktop */
            }
            .main-content {
                margin-left: 0px; /* Adjusted to 0 since mainMenu is part of flex flow */
            }
            .admin-header {
                flex-direction: row; /* Keep items in a row */
                align-items: center;
                margin-top: 0;
            }
            #pageTitle {
                text-align: center; /* Center on larger screens */
                flex-grow: 1; /* Allow it to take available space */
                order: initial;
            }
            #adminEmailDisplay {
                font-size: 14px; /* Default size for desktop */
                text-align: right; /* Align to right */
                width: auto; /* Auto width */
                margin-left: 20px; /* Space from title */
                order: initial;
            }
            .logout-btn {
                width: auto;
                order: initial;
                margin-left: 15px;
                margin-top: 0;
            }
            .result-item {
                flex-direction: row; /* Back to row on desktop */
                align-items: center;
            }
            .result-item-actions {
                flex-direction: row;
                width: auto;
            }
            .action-btn {
                width: auto !important; /* Auto width for desktop buttons */
            }
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="main-content">
        <div class="login-container">
            <h1>Admin Login</h1>
            <form id="loginForm">
                <div class="form-group"><label for="loginEmail">Email</label><input type="email" id="loginEmail" required></div>
                <div class="form-group"><label for="loginPassword">Password</label><input type="password" id="loginPassword" required></div>
                <button type="submit">Login<span class="spinner"></span></button>
            </form>
            <div id="loginMessage" class="message"></div>
        </div>
    </div>

    <div id="adminPanel" style="display: none; width: 100%;">
        <button id="menuToggleBtn"><i class="fas fa-bars"></i></button>
        <nav id="mainMenu">
            <div class="menu-header">Admin Menu</div>
            <a class="menu-link" data-page="addContentPage"><i class="fas fa-magic"></i> Add from TMDB</a>
            <a class="menu-link" data-page="manualAddPage"><i class="fas fa-edit"></i> Manual Add</a>
            <a class="menu-link" data-page="manageContentPage"><i class="fas fa-search"></i> Search & Edit/Delete</a>
            <a class="menu-link" data-page="bannerPage"><i class="fas fa-images"></i> Manage Banners</a>
            <a class="menu-link" data-page="userManagementPage"><i class="fas fa-users-cog"></i> User Management</a>
        </nav>

        <div class="main-content" id="mainContentArea">
            <div class="admin-header">
                <h1 id="pageTitle"></h1>
                <span id="adminEmailDisplay" style="font-weight: normal;"></span> <button class="logout-btn" id="logoutBtn">Logout <i class="fas fa-sign-out-alt"></i></button>
            </div>

            <div id="addContentPage" class="page-container">
                <h2>Add Content from TMDB</h2>
                <form id="addMovieForm">
                    <div class="form-group"><label for="tmdbApiKey">TMDB API Key</label><input type="text" id="tmdbApiKey" value="7707eccc54e32b83ac790b5352c67ed3" readonly></div>
                    <div class="form-group"><label for="primaryContentType">Primary Content Type</label><select id="primaryContentType" class="primary-content-type-selector" required><option value="movie">Movie</option><option value="tv">TV Series</option></select></div>
                    <div class="form-group media-categories-group">
                        <label>Categories (Select all that apply)</label>
                        <div class="checkbox-group" id="contentTypeCheckboxes">
                            <label><input type="checkbox" name="contentType" value="movie"> Latest movies</label>
                            <label><input type="checkbox" name="contentType" value="animation"> Animation</label>
                            <label><input type="checkbox" name="contentType" value="popular"> Requested Movies</label>
                            <label><input type="checkbox" name="contentType" value="indian"> Indian</label>
                            <label><input type="checkbox" name="contentType" value="horror"> Horror</label>
                            <label><input type="checkbox" name="contentType" value="comedy"> Comedy</label>
                            <label><input type="checkbox" name="contentType" value="romance"> Romance</label>
                            <label><input type="checkbox" name="contentType" value="adventure"> Adventure</label>
                            <label><input type="checkbox" name="contentType" value="scifi-fantasy"> Sci-fi & Fantasy</label>
                            <label><input type="checkbox" name="contentType" value="action-thriller"> Action & Thriller</label>
                            <label><input type="checkbox" name="contentType" value="high-school"> High School</label>
                            <label><input type="checkbox" name="contentType" value="nigerian"> Nigerian Movies</label>
                        </div>
                    </div>
                    <div class="form-group"><label for="contentIdentifier">Content Name or TMDB ID</label><input type="text" id="contentIdentifier" placeholder="e.g., The Matrix or TMDB ID 603" required></div>
                    <div class="form-group"><label for="vjName">VJ Name</label><input type="text" id="vjName" required></div>
                    <div class="form-group video-url-group"><label for="videoSourceUrl">Video Source URL</label><input type="url" id="videoSourceUrl" placeholder="e.g., https://example.com/video.mp4"></div>
                    <div class="form-group series-data-group" style="display: none;"><label for="seriesData">Series Data (JSON)</label><textarea id="seriesData" rows="8"></textarea></div>
                    <button type="submit" id="addContentBtn">Add Content<span class="spinner"></span></button>
                </form>
                <div id="addMessage" class="message"></div>
            </div>

            <div id="manualAddPage" class="page-container">
                <h2>Manually Add Content</h2>
                <form id="manualAddForm">
                    <div class="form-group"><label for="manualTitle">Title</label><input type="text" id="manualTitle" required></div>
                    <div class="form-group"><label for="manualOverview">Overview</label><textarea id="manualOverview" rows="4" required></textarea></div>
                    <div class="form-group"><label for="manualPosterUrl">Poster Image URL</label><input type="url" id="manualPosterUrl" required></div>
                    <div class="form-group"><label for="manualVjName">VJ Name</label><input type="text" id="manualVjName" required></div>
                    <div class="form-group"><label for="manualPrimaryContentType">Primary Content Type</label><select id="manualPrimaryContentType" class="primary-content-type-selector" required><option value="movie">Movie</option><option value="tv">TV Series</option></select></div>
                    <div class="form-group media-categories-group">
                        <label>Categories</label>
                        <div class="checkbox-group" id="manualContentTypeCheckboxes">
                            <label><input type="checkbox" name="manualContentType" value="movie">Latest Movies</label>
                            <label><input type="checkbox" name="manualContentType" value="animation"> Animation</label>
                            <label><input type="checkbox" name="manualContentType" value="popular"> Popular</label>
                            <label><input type="checkbox" name="manualContentType" value="indian"> Indian</label>
                            <label><input type="checkbox" name="manualContentType" value="horror"> Horror</label>
                            <label><input type="checkbox" name="manualContentType" value="comedy"> Comedy</label>
                            <label><input type="checkbox" name="manualContentType" value="romance"> Romance</label>
                            <label><input type="checkbox" name="manualContentType" value="adventure"> Adventure</label>
                            <label><input type="checkbox" name="manualContentType" value="scifi-fantasy"> Sci-fi & Fantasy</label>
                            <label><input type="checkbox" name="manualContentType" value="action-thriller"> Action & Thriller</label>
                            <label><input type="checkbox" name="manualContentType" value="high-school"> High School</label>
                            <label><input type="checkbox" name="manualContentType" value="nigerian"> Nigerian Movies</label>
                        </div>
                    </div>
                    <div class="form-group"><label for="manualTmdbId">Reference ID (Optional)</label><input type="text" id="manualTmdbId" placeholder="Enter TMDB ID if known"></div>
                    <div class="form-group video-url-group"><label for="manualVideoSourceUrl">Video Source URL</label><input type="url" id="manualVideoSourceUrl"></div>
                    <div class="form-group series-data-group" style="display: none;"><label for="manualSeriesData">Series Data (JSON)</label><textarea id="manualSeriesData" rows="8"></textarea></div>
                    <button type="submit" id="manualAddContentBtn">Add Manually<span class="spinner"></span></button>
                </form>
                <div id="manualAddMessage" class="message"></div>
            </div>

            <div id="manageContentPage" class="page-container">
                <h2>Search & Manage Content</h2>
                <form id="manageContentForm">
                    <div class="form-group">
                        <label for="manageContentIdentifier">Search by Content Name or TMDB ID</label>
                        <input type="text" id="manageContentIdentifier" required>
                    </div>
                    <button type="button" id="searchManageBtn">Search Content<span class="spinner"></span></button>
                </form>
                <div id="manageSearchResults" style="margin-top: 20px;"></div>
                <button type="button" id="confirmDeleteBtn" style="display: none; background-color: var(--danger-color);">Delete Selected Content<span class="spinner"></span></button>
                <div id="manageMessage" class="message"></div>
            </div>

            <div id="editContentPage" class="page-container">
                <h2>Edit Content</h2>
                <form id="editContentForm">
                    <input type="hidden" id="editDocId">
                    <div class="form-group"><label for="editTitle">Title</label><input type="text" id="editTitle" required></div>
                    <div class="form-group"><label for="editOverview">Overview</label><textarea id="editOverview" rows="4" required></textarea></div>
                    <div class="form-group"><label for="editPosterUrl">Poster Image URL</label><input type="url" id="editPosterUrl" required></div>
                    <div class="form-group"><label for="editVjName">VJ Name</label><input type="text" id="editVjName" required></div>
                    <div class="form-group"><label for="editPrimaryContentType">Primary Content Type</label><select id="editPrimaryContentType" class="primary-content-type-selector" required><option value="movie">Movie</option><option value="tv">TV Series</option></select></div>
                    <div class="form-group media-categories-group">
                        <label>Categories</label>
                        <div class="checkbox-group" id="editContentTypeCheckboxes">
                            <label><input type="checkbox" name="editContentType" value="movie">Latest Movies</label>
                            <label><input type="checkbox" name="editContentType" value="animation"> Animation</label>
                            <label><input type="checkbox" name="editContentType" value="popular"> Requested Movies</label>
                            <label><input type="checkbox" name="editContentType" value="indian"> Indian</label>
                            <label><input type="checkbox" name="editContentType" value="horror"> Horror</label>
                            <label><input type="checkbox" name="editContentType" value="comedy"> Comedy</label>
                            <label><input type="checkbox" name="editContentType" value="romance"> Romance</label>
                            <label><input type="checkbox" name="editContentType" value="adventure"> Adventure</label>
                            <label><input type="checkbox" name="editContentType" value="scifi-fantasy"> Sci-fi & Fantasy</label>
                            <label><input type="checkbox" name="editContentType" value="action-thriller"> Action & Thriller</label>
                            <label><input type="checkbox" name="editContentType" value="high-school"> High School</label>
                            <label><input type="checkbox" name="editContentType" value="nigerian"> Nigerian Movies</label>
                        </div>
                    </div>
                    <div class="form-group"><label for="editTmdbId">Reference ID (Optional)</label><input type="text" id="editTmdbId" placeholder="Enter TMDB ID if known"></div>
                    <div class="form-group video-url-group"><label for="editVideoSourceUrl">Video Source URL</label><input type="url" id="editVideoSourceUrl"></div>
                    <div class="form-group series-data-group" style="display: none;"><label for="editSeriesData">Series Data (JSON)</label><textarea id="editSeriesData" rows="8"></textarea></div>
                    <button type="submit" id="updateContentBtn">Update Content<span class="spinner"></span></button>
                    <button type="button" id="cancelEditBtn" style="background-color: gray; margin-top: 10px;">Cancel Edit</button>
                </form>
                <div id="editMessage" class="message"></div>
            </div>

            <div id="bannerPage" class="page-container">
                <div class="banner-nav-tabs">
                    <button class="banner-tab-link" data-tab="viewBannersTab">View All Banners</button>
                    <button class="banner-tab-link" data-tab="addBannerTab">Add/Edit Banner</button>
                </div>
                
                <div id="addBannerTab" class="banner-tab-content">
                    <h2 id="bannerFormTitle">Add New Banner</h2>
                    <form id="addEditBannerForm">
                        <input type="hidden" id="bannerDocId">
                        <div class="form-group"><label for="bannerTitle">Banner Title</label><input type="text" id="bannerTitle" required></div>
                        <div class="form-group"><label for="bannerImageUrl">Image URL</label><input type="text" id="bannerImageUrl" required></div>
                        <div class="form-group"><label for="bannerDescription">Description</label><textarea id="bannerDescription" rows="3"></textarea></div>
                        <div class="form-group"><label for="bannerLink">"Watch Now" Link</label><input type="text" id="bannerLink" required></div>
                        <button type="submit" id="saveBannerBtn">Save Banner<span class="spinner"></span></button>
                        <button type="button" id="cancelEditBannerBtn" style="display:none; background: gray;">Cancel Edit / New</button>
                    </form>
                    <div id="addBannerMessage" class="message"></div>
                </div>

                <div id="viewBannersTab" class="banner-tab-content">
                    <h2>All Available Banners</h2>
                    <div id="allBannersContainer"></div>
                    <div id="viewBannersMessage" class="message"></div>
                </div>
            </div>

            <div id="userManagementPage" class="page-container">
                <h2>User Management Panel</h2>
                
                <div id="user-search-section">
                    <div class="input-group">
                        <label for="user-search-email">Search User by Email</label>
                        <input type="email" id="user-search-email" placeholder="user@example.com" />
                    </div>
                    <button class="btn" id="user-search-btn">Search User</button>
                </div>

                <div id="user-message-area" class="message hidden"></div>
                <hr class="hidden" id="user-form-divider" />

                <div id="user-edit-form-section" class="hidden">
                    <h3 id="user-form-title">Edit User</h3>
                    <div class="input-group"><label for="user-doc-id">Document ID (User UID)</label><input type="text" id="user-doc-id" disabled /></div>
                    <div class="input-group"><label for="user-edit-name">Full Name</label><input type="text" id="user-edit-name" /></div>
                    <div class="input-group"><label for="user-edit-email">Email</label><input type="email" id="user-edit-email" /></div>
                    <div class="input-group"><label for="user-edit-activated">Account Activated</label><select id="user-edit-activated"><option value="true">True</option><option value="false">False</option></select></div>
                    <div class="input-group"><label for="user-edit-expiresAt">Subscription Expiration</label><input type="datetime-local" id="user-edit-expiresAt" /></div>
                    <button class="btn" id="user-update-btn">Update Document</button>
                    <button class="btn btn-secondary" id="user-create-btn">Create New Document</button>
                </div>
            </div>

        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase Configurations ---
            const primaryFirebaseConfig = {
                apiKey: "AIzaSyAn2vbkT9yjyWtJzNSHgRureco5gEjYd_Q",
                authDomain: "stream-zone-movies-a83c1.firebaseapp.com",
                projectId: "stream-zone-movies-a83c1",
                storageBucket: "stream-zone-movies-a83c1.appspot.com",
                messagingSenderId: "148342664213",
                appId: "1:148342664213:web:56df2549cc480df7cf721c"
            };

            const secondary1FirebaseConfig = {
                apiKey: "AIzaSyCQhwMc1uYLmjLMmBWk5QpT3XcLsuzBIEQ",
                authDomain: "reyikingtv1.firebaseapp.com",
                projectId: "reyikingtv1",
                storageBucket: "reyikingtv1.firebaseapp.com",
                messagingSenderId: "617666017039",
                appId: "1:617666017039:web:5fa4ce795d9a0da0cfb07a"
            };

            const secondary2FirebaseConfig = {
                apiKey: "AIzaSyCgbaRR6ezvswehl1Q21ICHgBtXZ9bcLwA",
                authDomain: "my-movies-admin.firebaseapp.com",
                projectId: "my-movies-admin",
                storageBucket: "my-movies-admin.appspot.com",
                messagingSenderId: "492775126123",
                appId: "1:492775126123:web:7ad51095ff15f61ed12d2e"
            };

            // --- Initialize Firebase Apps ---
            const app = firebase.initializeApp(primaryFirebaseConfig);
            const db = firebase.firestore(app);
            const auth = firebase.auth(app);
            const secondaryApp1 = firebase.initializeApp(secondary1FirebaseConfig, 'reyikingtv1');
            const db1 = firebase.firestore(secondaryApp1);
            const secondaryApp2 = firebase.initializeApp(secondary2FirebaseConfig, 'my-movies-admin');
            const db2 = firebase.firestore(secondaryApp2);
            const dbsToCheck = [ { name: primaryFirebaseConfig.projectId, instance: db }, { name: secondary1FirebaseConfig.projectId, instance: db1 }, { name: secondary2FirebaseConfig.projectId, instance: db2 } ];
            
            // --- DOM Element References ---
            const loginScreen = document.getElementById('loginScreen');
            const adminPanel = document.getElementById('adminPanel');
            const mainMenu = document.getElementById('mainMenu');
            const menuToggleBtn = document.getElementById('menuToggleBtn');
            const pageTitle = document.getElementById('pageTitle');
            const adminEmailDisplay = document.getElementById('adminEmailDisplay'); 
            const logoutBtn = document.getElementById('logoutBtn');
            const loginMessage = document.getElementById('loginMessage');

            // Content Management Elements
            const addMovieForm = document.getElementById('addMovieForm');
            const addContentBtn = document.getElementById('addContentBtn');
            const addMessage = document.getElementById('addMessage');
            const manualAddForm = document.getElementById('manualAddForm');
            const manualAddBtn = document.getElementById('manualAddContentBtn');
            const manualAddMessage = document.getElementById('manualAddMessage');
            const searchManageBtn = document.getElementById('searchManageBtn');
            const manageSearchResults = document.getElementById('manageSearchResults');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const manageMessage = document.getElementById('manageMessage');
            const editContentForm = document.getElementById('editContentForm');
            const updateContentBtn = document.getElementById('updateContentBtn');
            const editMessage = document.getElementById('editMessage');
            const cancelEditBtn = document.getElementById('cancelEditBtn');

            // Banner Management Elements
            const bannerNavTabs = document.querySelector('.banner-nav-tabs');
            const addEditBannerForm = document.getElementById('addEditBannerForm');
            const bannerFormTitle = document.getElementById('bannerFormTitle');
            const bannerDocId = document.getElementById('bannerDocId');
            const saveBannerBtn = document.getElementById('saveBannerBtn');
            const cancelEditBannerBtn = document.getElementById('cancelEditBannerBtn');
            const addBannerMessage = document.getElementById('addBannerMessage');
            const allBannersContainer = document.getElementById('allBannersContainer');
            const viewBannersMessage = document.getElementById('viewBannersMessage');
            let selectedMoviesForDeletion = new Set();

            // User Management Elements (New)
            const userSearchEmailInput = document.getElementById('user-search-email');
            const userSearchBtn = document.getElementById('user-search-btn');
            const userMessageArea = document.getElementById('user-message-area');
            const userEditFormSection = document.getElementById('user-edit-form-section');
            const userFormDivider = document.getElementById('user-form-divider');
            const userDocIdInput = document.getElementById('user-doc-id');
            const userEditNameInput = document.getElementById('user-edit-name');
            const userEditEmailInput = document.getElementById('user-edit-email');
            const userEditActivatedSelect = document.getElementById('user-edit-activated');
            const userEditExpiresAtInput = document.getElementById('user-edit-expiresAt');
            const userUpdateBtn = document.getElementById('user-update-btn');
            const userCreateBtn = document.getElementById('user-create-btn');
            const userFormTitle = document.getElementById('user-form-title'); 


            // --- Helper Functions ---
            function setLoading(button, isLoading) {
                if(button) {
                    button.classList.toggle('loading', isLoading);
                    button.disabled = isLoading;
                }
            }

            function displayMessage(element, msg, type) {
                if (element) {
                    element.textContent = msg;
                    element.className = `message ${type}`;
                    element.style.display = 'block';
                    setTimeout(() => { element.style.display = 'none'; }, 8000);
                }
            }
            
            async function checkForDuplicates(payload, excludeDocId = null) {
                const checkByTmdbId = payload.tmdbId && String(payload.tmdbId).trim() !== '';
                const valueToCheck = checkByTmdbId ? Number(payload.tmdbId) : payload.title;
                const fieldToCheck = checkByTmdbId ? 'tmdbId' : 'title';

                for (const dbInfo of dbsToCheck) {
                    try {
                        const query = dbInfo.instance.collection('movies').where(fieldToCheck, '==', valueToCheck);
                        const snapshot = await query.get();
                        for (const doc of snapshot.docs) {
                            if (excludeDocId && dbInfo.name === primaryFirebaseConfig.projectId && doc.id === excludeDocId) {
                                continue;
                            }
                            return { found: true, project: dbInfo.name };
                        }
                    } catch (error) {
                         console.error(`Error checking duplicates in ${dbInfo.name}:`, error);
                    }
                }
                return { found: false, project: null };
            }

            // User Management specific helper functions
            function hideUserMessage() { userMessageArea.classList.add('hidden'); }
            function clearUserForm() {
                userDocIdInput.value = '';
                userEditNameInput.value = '';
                userEditEmailInput.value = '';
                userEditActivatedSelect.value = 'true';
                userEditExpiresAtInput.value = '';
                userEditFormSection.classList.add('hidden');
                userFormDivider.classList.add('hidden');
                hideUserMessage();
            }
            function formatTimestampForInput(timestamp) {
                if (!timestamp || typeof timestamp.toDate !== 'function') return '';
                const date = timestamp.toDate();
                const timezoneOffset = date.getTimezoneOffset() * 60000;
                const localDate = new Date(date.getTime() - timezoneOffset);
                return localDate.toISOString().slice(0, 16);
            }
            function displayUserMessage(text, type = 'success') {
                userMessageArea.textContent = text;
                userMessageArea.className = `message ${type}`;
                userMessageArea.classList.remove('hidden');
            }


            // --- Auth and Navigation ---
            auth.onAuthStateChanged(user => {
                loginScreen.style.display = user ? 'none' : 'flex';
                adminPanel.style.display = user ? 'flex' : 'none';
                menuToggleBtn.style.display = user ? 'flex' : 'none'; // Ensure button visibility is controlled
                if(user) {
                    adminEmailDisplay.textContent = `Logged in as: ${user.email}`;
                    navigateToPage('addContentPage'); // Default page after login
                } else {
                    adminEmailDisplay.textContent = '';
                }
            });

            document.getElementById('loginForm').addEventListener('submit', async e => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                setLoading(btn, true);
                try {
                    await auth.signInWithEmailAndPassword(document.getElementById('loginEmail').value, document.getElementById('loginPassword').value);
                    displayMessage(loginMessage, '', ''); // Clear any previous login message
                } catch (error) {
                    displayMessage(loginMessage, 'Invalid credentials.', 'error');
                } finally {
                    setLoading(btn, false);
                }
            });

            logoutBtn.addEventListener('click', () => auth.signOut());
            menuToggleBtn.addEventListener('click', () => mainMenu.classList.toggle('open'));
            
            function navigateToPage(pageId) {
                document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
                const page = document.getElementById(pageId);
                if (page) {
                    page.classList.add('active');
                    if (pageId === 'bannerPage') {
                        const viewBannersTabLink = document.querySelector('.banner-tab-link[data-tab="viewBannersTab"]');
                        if (viewBannersTabLink) {
                            viewBannersTabLink.click();
                        }
                    }
                }
                document.querySelectorAll('.menu-link').forEach(link => {
                    const isActive = link.dataset.page === pageId;
                    link.classList.toggle('active', isActive);
                    if (isActive) pageTitle.textContent = link.textContent.trim();
                });
                if (window.innerWidth < 768) mainMenu.classList.remove('open');
                window.scrollTo(0, 0);
            }
            document.querySelectorAll('.menu-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateToPage(e.currentTarget.dataset.page);
                });
            });

            function setupMasterContentTypeToggle(formElement) {
                const primarySelector = formElement.querySelector('.primary-content-type-selector');
                const mediaCategoriesGroup = formElement.querySelector('.media-categories-group');
                const videoUrlGroup = formElement.querySelector('.video-url-group');
                const seriesDataGroup = formElement.querySelector('.series-data-group');
                function toggleFields() {
                    const primaryType = primarySelector.value;
                    const isTV = primaryType === 'tv';
                    if(mediaCategoriesGroup) mediaCategoriesGroup.style.display = isTV ? 'none' : 'block';
                    if(videoUrlGroup) videoUrlGroup.style.display = isTV ? 'none' : 'block';
                    if(seriesDataGroup) seriesDataGroup.style.display = isTV ? 'block' : 'none';
                }
                if(primarySelector) {
                    primarySelector.addEventListener('change', toggleFields);
                    toggleFields(); 
                }
            }
            setupMasterContentTypeToggle(document.getElementById('addMovieForm'));
            setupMasterContentTypeToggle(document.getElementById('manualAddForm'));
            setupMasterContentTypeToggle(document.getElementById('editContentForm'));

            // --- TMDB Add Form Logic ---
            addMovieForm.addEventListener('submit', async e => {
                e.preventDefault();
                setLoading(addContentBtn, true);
                const primaryType = document.getElementById('primaryContentType').value;
                const isTV = primaryType === 'tv';
                const identifier = document.getElementById('contentIdentifier').value.trim();
                const vjName = document.getElementById('vjName').value.trim();
                const tmdbApiKey = document.getElementById('tmdbApiKey').value;
                const apiType = isTV ? 'tv' : 'movie';

                if (!vjName) {
                    displayMessage(addMessage, 'VJ Name is required.', 'error');
                    setLoading(addContentBtn, false);
                    return;
                }

                const tmdbData = await (async (id, key) => {
                    const isId = /^\d+$/.test(id);
                    const url = isId ? `https://api.themoviedb.org/3/${apiType}/${id}?api_key=${key}` : `https://api.themoviedb.org/3/search/${apiType}?api_key=${key}&query=${encodeURIComponent(id)}`;
                    try {
                        const r = await fetch(url);
                        if (!r.ok) {
                            console.error(`TMDB API error: ${r.status} ${r.statusText}`);
                            return null;
                        }
                        const d = await r.json();
                        return isId ? d : (d.results?.[0] || null);
                    } catch (err) {
                        console.error("Error fetching from TMDB:", err);
                        return null;
                    }
                })(identifier, tmdbApiKey);

                if (!tmdbData || !tmdbData.id) {
                    displayMessage(addMessage, 'Could not find content on TMDB. Check name/ID or API key.', 'error');
                    setLoading(addContentBtn, false);
                    return;
                }

                const finalTitle = tmdbData.title || tmdbData.name;
                const payload = {
                    title: finalTitle,
                    tmdbId: tmdbData.id,
                    posterUrl: tmdbData.poster_path ? `https://image.tmdb.org/t/p/w500${tmdbData.poster_path}` : '',
                    overview: tmdbData.overview || "N/A",
                    vjName: vjName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    addedBy: auth.currentUser.email
                };

                if (isTV) {
                    payload.contentType = 'tv';
                    payload.type = 'tv';
                    try {
                        const seriesDataValue = document.getElementById('seriesData').value;
                        if(!seriesDataValue) {
                            displayMessage(addMessage, "Series Data (JSON) cannot be empty for TV series.", 'error');
                            setLoading(addContentBtn, false);
                            return;
                        }
                        payload.seriesInfo = JSON.parse(seriesDataValue);
                    } catch (err) {
                        displayMessage(addMessage, `Invalid JSON in Series Data: ${err.message}`, 'error');
                        setLoading(addContentBtn, false);
                        return;
                    }
                } else { 
                    const selectedTypes = Array.from(document.querySelectorAll('#contentTypeCheckboxes input:checked')).map(cb => cb.value);
                    if(selectedTypes.length === 0) {
                        displayMessage(addMessage, 'Please select at least one category for movies.', 'error');
                        setLoading(addContentBtn, false);
                        return;
                    }
                    payload.contentType = 'movie';
                    payload.type = selectedTypes;
                    payload.videoUrl = document.getElementById('videoSourceUrl').value;
                }

                try {
                    const duplicateCheck = await checkForDuplicates(payload);
                    if (duplicateCheck.found) {
                        displayMessage(addMessage, `Duplicate found in project: ${duplicateCheck.project}. Addition denied.`, 'error');
                    } else {
                        await db.collection('movies').add(payload);
                        displayMessage(addMessage, 'Content added successfully!', 'success');
                        addMovieForm.reset();
                    }
                } catch (error) {
                    console.error("Error adding document:", error);
                    displayMessage(addMessage, `Error: ${error.message}`, 'error');
                } finally {
                    setLoading(addContentBtn, false);
                }
            });
            
            // --- Manual Add Form Logic ---
            manualAddForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                setLoading(manualAddBtn, true);
                const primaryType = document.getElementById('manualPrimaryContentType').value;
                const isTV = primaryType === 'tv';
                const manualVjName = document.getElementById('manualVjName').value.trim();

                if (!manualVjName) {
                    displayMessage(manualAddMessage, 'VJ Name is required.', 'error');
                    setLoading(manualAddBtn, false);
                    return;
                }

                let payload = {
                    title: document.getElementById('manualTitle').value.trim(),
                    overview: document.getElementById('manualOverview').value,
                    posterUrl: document.getElementById('manualPosterUrl').value,
                    vjName: manualVjName,
                    tmdbId: document.getElementById('manualTmdbId').value.trim() || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    addedBy: auth.currentUser.email
                };

                if (isTV) {
                    payload.contentType = 'tv';
                    payload.type = 'tv';
                    try {
                        const seriesDataValue = document.getElementById('manualSeriesData').value;
                        if(!seriesDataValue) {
                            displayMessage(manualAddMessage, "Series Data (JSON) cannot be empty for TV series.", 'error');
                            setLoading(manualAddBtn, false);
                            return;
                        }
                        payload.seriesInfo = JSON.parse(seriesDataValue);
                    } catch (err) {
                        displayMessage(manualAddMessage, `Invalid JSON in Series Data: ${err.message}`, 'error');
                        setLoading(manualAddBtn, false);
                        return;
                    }
                } else {
                    const selectedTypes = Array.from(document.querySelectorAll('#manualContentTypeCheckboxes input:checked')).map(cb => cb.value);
                    if (selectedTypes.length === 0) {
                        displayMessage(manualAddMessage, 'Please select at least one category for movies.', 'error');
                        setLoading(manualAddBtn, false);
                        return;
                    }
                    payload.contentType = 'movie';
                    payload.type = selectedTypes;
                    payload.videoUrl = document.getElementById('manualVideoSourceUrl').value;
                }

                try {
                    const duplicateCheck = await checkForDuplicates(payload);
                    if (duplicateCheck.found) {
                        displayMessage(manualAddMessage, `Duplicate found in project: ${duplicateCheck.project}. Addition denied.`, 'error');
                    } else {
                        await db.collection('movies').add(payload);
                        displayMessage(manualAddMessage, 'Content added successfully!', 'success');
                        manualAddForm.reset();
                    }
                } catch (error) {
                    console.error("Error adding document manually:", error);
                    displayMessage(manualAddMessage, `Error: ${error.message}`, 'error');
                } finally {
                    setLoading(manualAddBtn, false);
                }
            });

            // --- Manage (Search, Edit, Delete) Logic ---
            searchManageBtn.addEventListener('click', async () => {
                setLoading(searchManageBtn, true);
                manageSearchResults.innerHTML = '';
                selectedMoviesForDeletion.clear();
                confirmDeleteBtn.style.display = 'none';
                const term = document.getElementById('manageContentIdentifier').value.trim();
                if (!term) {
                    displayMessage(manageMessage, 'Enter a name or ID to search.', 'error');
                    setLoading(searchManageBtn, false);
                    return;
                }
                
                try {
                    const isId = /^\d+$/.test(term);
                    let docs = [];
                    let querySnapshot;

                    if(isId) {
                        querySnapshot = await db.collection('movies').where('tmdbId', '==', Number(term)).get();
                        querySnapshot.forEach(doc => docs.push(doc));
                    } else {
                        querySnapshot = await db.collection('movies').get();
                        const lowerCaseTerm = term.toLowerCase();
                        querySnapshot.forEach(doc => {
                            if((doc.data().title || '').toLowerCase().includes(lowerCaseTerm)) {
                                docs.push(doc);
                            }
                        });
                    }
                    
                    if(docs.length === 0) {
                        displayMessage(manageMessage, 'No content found matching your search.', 'info');
                    } else {
                        docs.forEach(doc => {
                            const item = doc.data();
                            manageSearchResults.innerHTML += `
                                <div class="result-item">
                                    <span><strong>${item.title}</strong> (TMDB ID: ${item.tmdbId || 'N/A'}) - Type: ${item.contentType || 'N/A'}</span>
                                    <div class="result-item-actions">
                                        <button class="action-btn edit" data-id="${doc.id}">Edit</button>
                                        <button class="action-btn select-delete" data-id="${doc.id}">Select</button>
                                    </div>
                                </div>
                            `;
                        });
                        displayMessage(manageMessage, `Found ${docs.length} item(s).`, 'success');
                    }
                } catch (err) {
                    console.error("Error searching content:", err);
                    displayMessage(manageMessage, `Error searching content: ${err.message}`, 'error');
                } finally {
                    setLoading(searchManageBtn, false);
                }
            });
            
            manageSearchResults.addEventListener('click', e => {
                if(e.target.matches('.select-delete')){
                    const btn = e.target;
                    const id = btn.dataset.id;
                    if(selectedMoviesForDeletion.has(id)){
                        selectedMoviesForDeletion.delete(id);
                        btn.classList.remove('selected');
                        btn.textContent = 'Select';
                    } else {
                        selectedMoviesForDeletion.add(id);
                        btn.classList.add('selected');
                        btn.textContent = 'Selected';
                    }
                    confirmDeleteBtn.style.display = selectedMoviesForDeletion.size > 0 ? 'block' : 'none';
                    confirmDeleteBtn.textContent = `Delete Selected (${selectedMoviesForDeletion.size})`;
                }
                if (e.target.matches('.action-btn.edit')) {
                    const docId = e.target.dataset.id;
                    loadContentForEditing(docId);
                }
            });
            
            confirmDeleteBtn.addEventListener('click', async () => {
                if(confirm(`Are you sure you want to delete ${selectedMoviesForDeletion.size} item(s)? This action cannot be undone.`)){
                    setLoading(confirmDeleteBtn, true);
                    const batch = db.batch();
                    selectedMoviesForDeletion.forEach(id => batch.delete(db.collection('movies').doc(id)));
                    try {
                        await batch.commit();
                        displayMessage(manageMessage, `Deleted ${selectedMoviesForDeletion.size} items successfully.`, 'success');
                        manageSearchResults.innerHTML = '';
                        confirmDeleteBtn.style.display = 'none';
                        selectedMoviesForDeletion.clear();
                    } catch(err){
                        console.error("Error deleting content:", err);
                        displayMessage(manageMessage, `Error deleting content: ${err.message}`, 'error');
                    } finally {
                        setLoading(confirmDeleteBtn, false);
                    }
                }
            });

            // --- Edit Content Logic ---
            async function loadContentForEditing(id) {
                try {
                    const docRef = db.collection('movies').doc(id);
                    const doc = await docRef.get();
                    if (!doc.exists) {
                        displayMessage(manageMessage, 'Content not found or already deleted.', 'error');
                        return;
                    }
                    const data = doc.data();
                    
                    editContentForm.reset();
                    document.getElementById('editDocId').value = doc.id;
                    document.getElementById('editTitle').value = data.title || '';
                    document.getElementById('editOverview').value = data.overview || '';
                    document.getElementById('editPosterUrl').value = data.posterUrl || '';
                    document.getElementById('editVjName').value = data.vjName || '';
                    document.getElementById('editTmdbId').value = data.tmdbId || '';

                    const primaryTypeSelector = document.getElementById('editPrimaryContentType');
                    primaryTypeSelector.value = data.contentType === 'tv' ? 'tv' : 'movie';
                    primaryTypeSelector.dispatchEvent(new Event('change')); 

                    document.querySelectorAll('#editContentTypeCheckboxes input').forEach(cb => {
                        cb.checked = false; 
                    });
                    if (data.contentType === 'movie' && Array.isArray(data.type)) {
                        data.type.forEach(typeValue => {
                            const checkbox = document.querySelector(`#editContentTypeCheckboxes input[value="${typeValue}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                        document.getElementById('editVideoSourceUrl').value = data.videoUrl || '';
                    } else if (data.contentType === 'tv') {
                        document.getElementById('editSeriesData').value = data.seriesInfo ? JSON.stringify(data.seriesInfo, null, 2) : '';
                    }

                    navigateToPage('editContentPage');
                } catch (err) {
                    console.error("Error loading content for editing:", err);
                    displayMessage(manageMessage, `Error loading content: ${err.message}`, 'error');
                }
            }

            editContentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                setLoading(updateContentBtn, true);
                const docId = document.getElementById('editDocId').value;
                if (!docId) {
                    displayMessage(editMessage, 'No document ID found. Cannot update.', 'error');
                    setLoading(updateContentBtn, false);
                    return;
                }
                const editVjName = document.getElementById('editVjName').value.trim();
                if (!editVjName) {
                    displayMessage(editMessage, 'VJ Name is required.', 'error');
                    setLoading(updateContentBtn, false);
                    return;
                }

                const primaryType = document.getElementById('editPrimaryContentType').value;
                const isTV = primaryType === 'tv';
                let payload = {
                    title: document.getElementById('editTitle').value.trim(),
                    overview: document.getElementById('editOverview').value,
                    posterUrl: document.getElementById('editPosterUrl').value,
                    vjName: editVjName,
                    tmdbId: document.getElementById('editTmdbId').value.trim() || null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (isTV) {
                    payload.contentType = 'tv';
                    payload.type = 'tv';
                    try {
                        const seriesDataValue = document.getElementById('editSeriesData').value;
                        if(!seriesDataValue) {
                            displayMessage(editMessage, "Series Data (JSON) cannot be empty for TV series.", 'error');
                            setLoading(updateContentBtn, false);
                            return;
                        }
                        payload.seriesInfo = JSON.parse(seriesDataValue);
                    } catch (err) {
                        displayMessage(editMessage, `Invalid JSON in Series Data: ${err.message}`, 'error');
                        setLoading(updateContentBtn, false);
                        return;
                    }
                    payload.videoUrl = firebase.firestore.FieldValue.delete(); 
                } else { 
                    const selectedTypes = Array.from(document.querySelectorAll('#editContentTypeCheckboxes input:checked')).map(cb => cb.value);
                    if (selectedTypes.length === 0) {
                        displayMessage(editMessage, 'Please select at least one category for movies.', 'error');
                        setLoading(updateContentBtn, false);
                        return;
                    }
                    payload.contentType = 'movie';
                    payload.type = selectedTypes;
                    payload.videoUrl = document.getElementById('editVideoSourceUrl').value;
                    payload.seriesInfo = firebase.firestore.FieldValue.delete();
                }
                
                try {
                    await db.collection('movies').doc(docId).update(payload);
                    displayMessage(editMessage, 'Content updated successfully!', 'success');
                    setTimeout(() => {
                        navigateToPage('manageContentPage');
                        searchManageBtn.click(); 
                    }, 2000);
                } catch (error) {
                    console.error("Error updating content:", error);
                    displayMessage(editMessage, `Update Error: ${error.message}`, 'error');
                } finally {
                    setLoading(updateContentBtn, false);
                }
            });

            cancelEditBtn.addEventListener('click', () => { navigateToPage('manageContentPage'); });

            // --- Banner logic ---
            async function displayAllBanners() {
                allBannersContainer.innerHTML = '<div class="message info" style="display:block;">Loading banners...</div>';
                try {
                    const snapshot = await db.collection('banners').orderBy('updatedAt', 'desc').get();
                    if (snapshot.empty) {
                        allBannersContainer.innerHTML = '';
                        displayMessage(viewBannersMessage, 'No banners found. Add one from the "Add/Edit Banner" tab.', 'info');
                        return;
                    }
                    allBannersContainer.innerHTML = '';
                    snapshot.forEach(doc => {
                        const banner = doc.data();
                        const card = `
                            <div class="banner-card">
                                <img src="${banner.imageUrl}" alt="${banner.title}" onerror="this.src='https://placehold.co/500x300/333/eee?text=No+Image';">
                                <div class="banner-card-content">
                                    <h3>${banner.title}</h3>
                                    <p>${(banner.description || 'No description available.').substring(0, 100)}...</p>
                                    <div class="banner-card-actions">
                                        <button class="action-btn edit" data-id="${doc.id}">Edit</button>
                                        <button class="action-btn delete" data-id="${doc.id}">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        allBannersContainer.insertAdjacentHTML('beforeend', card);
                    });
                    displayMessage(viewBannersMessage, `Found ${snapshot.size} banner(s).`, 'success');
                } catch (err) {
                    console.error("Error displaying banners:", err);
                    allBannersContainer.innerHTML = '';
                    displayMessage(viewBannersMessage, `Error: ${err.message}`, 'error');
                }
            }

            bannerNavTabs.addEventListener('click', e => {
                if (e.target.matches('.banner-tab-link')) {
                    const tabId = e.target.dataset.tab;
                    document.querySelectorAll('.banner-tab-link').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.banner-tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    if (tabId === 'viewBannersTab') {
                        displayAllBanners();
                    }
                }
            });

            allBannersContainer.addEventListener('click', async e => {
                const target = e.target;
                if (target.matches('.action-btn.delete')) {
                    const docId = target.dataset.id;
                    if (confirm('Are you sure you want to delete this banner permanently?')) {
                        setLoading(target, true);
                        try {
                            await db.collection('banners').doc(docId).delete();
                            displayMessage(viewBannersMessage, 'Banner deleted successfully!', 'success');
                            await displayAllBanners();
                        } catch (err) {
                            console.error("Error deleting banner:", err);
                            displayMessage(viewBannersMessage, `Error deleting banner: ${err.message}`, 'error');
                            setLoading(target, false);
                        }
                    }
                }
                if (target.matches('.action-btn.edit')) {
                    await loadBannerForEditing(target.dataset.id);
                }
            });

            addEditBannerForm.addEventListener('submit', async e => {
                e.preventDefault();
                setLoading(saveBannerBtn, true);
                const id = bannerDocId.value;
                const data = {
                    title: document.getElementById('bannerTitle').value.trim(),
                    imageUrl: document.getElementById('bannerImageUrl').value,
                    description: document.getElementById('bannerDescription').value,
                    link: document.getElementById('bannerLink').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (!data.title || !data.imageUrl || !data.link) {
                    displayMessage(addBannerMessage, 'Title, Image URL, and Link are required for banners.', 'error');
                    setLoading(saveBannerBtn, false);
                    return;
                }

                try {
                    if (id) {
                        await db.collection('banners').doc(id).update(data);
                    } else {
                        await db.collection('banners').add({ ...data, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    }
                    displayMessage(addBannerMessage, 'Banner saved successfully!', 'success');
                    resetBannerForm();
                    document.querySelector('.banner-tab-link[data-tab="viewBannersTab"]').click(); 
                } catch (err) {
                    console.error("Error saving banner:", err);
                    displayMessage(addBannerMessage, `Error saving banner: ${err.message}`, 'error');
                } finally {
                    setLoading(saveBannerBtn, false);
                }
            });

            function resetBannerForm() {
                addEditBannerForm.reset();
                bannerDocId.value = '';
                bannerFormTitle.textContent = 'Add New Banner';
                saveBannerBtn.textContent = 'Save Banner';
                cancelEditBannerBtn.style.display = 'none';
                displayMessage(addBannerMessage, '', ''); 
            }
            cancelEditBannerBtn.addEventListener('click', resetBannerForm);

            async function loadBannerForEditing(id) {
                try {
                    const doc = await db.collection('banners').doc(id).get();
                    if (doc.exists) {
                        const d = doc.data();
                        bannerDocId.value = id;
                        document.getElementById('bannerTitle').value = d.title || '';
                        document.getElementById('bannerImageUrl').value = d.imageUrl || '';
                        document.getElementById('bannerDescription').value = d.description || '';
                        document.getElementById('bannerLink').value = d.link || '';
                        bannerFormTitle.textContent = 'Editing Banner';
                        saveBannerBtn.textContent = 'Update Banner';
                        cancelEditBannerBtn.style.display = 'inline-block';
                        document.querySelector('.banner-tab-link[data-tab="addBannerTab"]').click(); 
                        window.scrollTo(0, 0);
                    } else {
                        displayMessage(addBannerMessage, 'Banner not found.', 'error');
                    }
                } catch(err) {
                    console.error("Error loading banner for editing:", err);
                    displayMessage(addBannerMessage, 'Could not load banner for editing.', 'error');
                }
            }


            // --- User Management Logic ---
            userSearchBtn.addEventListener('click', async () => {
                const emailToSearch = userSearchEmailInput.value.trim();
                if (!emailToSearch) {
                    displayUserMessage('Please enter an email to search.', 'error');
                    return;
                }
                
                hideUserMessage();
                userEditFormSection.classList.add('hidden');
                userSearchBtn.disabled = true;
                userSearchBtn.textContent = 'Searching...';

                try {
                    const usersRef = db.collection("users");
                    const q = usersRef.where("email", "==", emailToSearch);
                    const querySnapshot = await q.get();

                    if (querySnapshot.empty) {
                        displayUserMessage(`No user found with email: ${emailToSearch}. You can create a new document.`, 'info'); 
                        clearUserForm();
                        userEditEmailInput.value = emailToSearch;
                        userFormTitle.textContent = "Create New User Document";
                        userDocIdInput.value = "Will be auto-generated upon creation";
                        userUpdateBtn.classList.add('hidden');
                        userCreateBtn.classList.remove('hidden');
                    } else {
                        const userDoc = querySnapshot.docs[0];
                        const userData = userDoc.data();
                        displayUserMessage('User found. You can now edit the details below.', 'success');
                        userDocIdInput.value = userDoc.id;
                        userEditNameInput.value = userData.name || '';
                        userEditEmailInput.value = userData.email || '';
                        userEditActivatedSelect.value = userData.activated ? 'true' : 'false';
                        userEditExpiresAtInput.value = formatTimestampForInput(userData.expiresAt);
                        userFormTitle.textContent = "Edit User Document";
                        userCreateBtn.classList.add('hidden');
                        userUpdateBtn.classList.remove('hidden');
                    }
                    userEditFormSection.classList.remove('hidden');
                    userFormDivider.classList.remove('hidden');
                } catch (error) {
                    console.error("Error searching user: ", error);
                    displayUserMessage(`An error occurred while searching: ${error.message}`, 'error');
                } finally {
                    userSearchBtn.disabled = false;
                    userSearchBtn.textContent = 'Search User';
                }
            });

            userUpdateBtn.addEventListener('click', async () => {
                const userId = userDocIdInput.value;
                if (!userId || userId === "Will be auto-generated upon creation") {
                    displayUserMessage('No user document ID found. Please search for a user or use "Create New Document".', 'error');
                    return;
                }
                userUpdateBtn.disabled = true;
                userUpdateBtn.textContent = 'Updating...';
                try {
                    const userDocRef = db.collection("users").doc(userId);
                    const dateValue = userEditExpiresAtInput.value ? new Date(userEditExpiresAtInput.value) : null;

                    await userDocRef.update({
                        name: userEditNameInput.value,
                        email: userEditEmailInput.value,
                        activated: userEditActivatedSelect.value === 'true',
                        expiresAt: dateValue ? firebase.firestore.Timestamp.fromDate(dateValue) : null 
                    });
                    displayUserMessage('User document updated successfully!', 'success');
                } catch (error) {
                    console.error("Error updating user document: ", error);
                    displayUserMessage(`Failed to update document: ${error.message}`, 'error');
                } finally {
                    userUpdateBtn.disabled = false;
                    userUpdateBtn.textContent = 'Update Document';
                }
            });

            userCreateBtn.addEventListener('click', async () => {
                const email = userEditEmailInput.value.trim();
                const name = userEditNameInput.value.trim();
                if (!email || !name) {
                    displayUserMessage('Email and Name are required to create a new document.', 'error');
                    return;
                }
                userCreateBtn.disabled = true;
                userCreateBtn.textContent = 'Creating...';
                try {
                    const newDocRef = db.collection("users").doc(); 
                    const dateValue = userEditExpiresAtInput.value ? new Date(userEditExpiresAtInput.value) : null;

                    await newDocRef.set({
                        name: name,
                        email: email,
                        phone: "", 
                        profileImage: "",
                        activated: userEditActivatedSelect.value === 'true',
                        expiresAt: dateValue ? firebase.firestore.Timestamp.fromDate(dateValue) : null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        deleted: false
                    });
                    userDocIdInput.value = newDocRef.id;
                    displayUserMessage(`New document created successfully with ID: ${newDocRef.id}`, 'success');
                    userCreateBtn.classList.add('hidden');
                    userUpdateBtn.classList.remove('hidden');
                    userFormTitle.textContent = "Edit User Document"; 
                } catch (error) {
                    console.error("Error creating user document: ", error);
                    displayUserMessage(`Failed to create document: ${error.message}`, 'error');
                } finally {
                    userCreateBtn.disabled = false;
                    userCreateBtn.textContent = 'Create New Document';
                }
            });
        });
    </script>
</body>
</html>
